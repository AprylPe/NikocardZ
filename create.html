<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Caveat+Brush&family=Playball&display=swap" rel="stylesheet">
	<style>

.container {
	display: flex;
	justify-content: center;
}
.cardBuilder {
	display: flex;
	flex-direction: column;
	width: 455px;
	height: 620px;
	padding: 10px;
	border: solid 2px #000;
	border-radius: 8px;
	background: #fff5eb;
}
.cardBuilder * {
	font-size: 16px;
}
#name {
	width: 60%;
	margin-bottom: 10px;
	padding: 8px;
}
#image {
	height: 300px;
	margin-bottom: 10px;
}
#effet {
	width: 80%;
	height: 150px;
	margin: 0 0 10px 10%;
}
.bottom {
	display: flex;
}
#force, #vie {
	flex: 1;
	height: 80px;
    font-size: 32px;
    text-align: center;
	margin-bottom: 10px;
}
#lore {
	flex: 5;
	height: 80px;
	margin-bottom: 10px;
}
input, textarea {
	border: solid 1px #808080;
	background: #fff5eb;
    border-radius: 8px;
	resize: none;
    box-shadow: 4px 4px 2px #DFC5B7;
}
textarea {
	text-align: center;
}
img {
	margin: auto;
    max-width: 90%;
    max-height: 90vh;
}
#cardPreview {
    display: flex;
}
.loadfonts {
	position: fixed;
	visibility: hidden;
	oppacity: 0;
}
	</style>
	<title>Nouvelle carte</title>

</head>
<body>
	<div class="loadfonts">
		<span style="font-family: 'Caveat Brush';">a</span>
		<span style="font-family: Playball;">a</span>
	</div>
	<div class="container">
		<div class="cardBuilder">
			<input type="text" id="name" placeholder="Nom" maxlength="30" required />
			<input type="file" id="image" accept="image/*" required />
			<textarea id="effet" required>Effet : </textarea>
			<div class="bottom">
				<input type="number" min="0" max="4" id="force" placeholder="Force" required />
				<textarea id="lore" placeholder="Lore" required></textarea>
				<input type="number" min="0" max="4" id="vie" placeholder="Vie" required />
			</div>
			<button id="generateButton">Générer la carte</button>
		</div>
	</div>

	<div id="cardPreview"></div>
	<script>
const WEBHOOK_DISCORD = "https://discord.com/api/webhooks/1238767593905717279/YA_YsxbnFMGQWifAjheOjA3xneZytMeAlgxMEn_fJwKuq9wV347BGkS337DiVLsA4Kip"
const DEFAULT_AVATAR = "https://static-cdn.jtvnw.net/emoticons/v2/emotesv2_a2b08e2a08db40ff886c76a7220a59d1/default/light/4.0"
const BASE_IMAGE_URL = "public/cards/model.png"; // URL vers l'image du template

document.addEventListener("DOMContentLoaded", function() {

	const generateButton = document.getElementById("generateButton");
//~ 	const sendButton = document.getElementById("sendButton");
//~ 	const resetButton = document.getElementById("resetButton");
//~ 	const imagePreview = document.getElementById("imagePreview");
//~ 	const form = document.getElementById("imageForm");

	generateButton.addEventListener("click", generateCard);
//~ 	sendButton.addEventListener("click", sendMessage);
//~ 	resetButton.addEventListener("click", resetForm);

	function generateImage() {
		// Créer un canvas
		const canvas = document.createElement("canvas");
		const ctx = canvas.getContext("2d");

		// Charger l'image de base depuis la constante en base64
		const baseImage = new Image();
		baseImage.src = "data:image/png;base64," + BASE_IMAGE_BASE64;

		baseImage.onload = function() {
			// Dessiner l'image de base sur le canvas
			canvas.width = baseImage.width;
			canvas.height = baseImage.height;
			ctx.drawImage(baseImage, 0, 0);

			// Ajouter du texte à des coordonnées spécifiques en fonction du jour
			ctx.textAlign = "center";
			ctx.fillStyle = "#220000";

			const currentDate = new Date();
			const currentDay = currentDate.getDay(); // 0 = dimanche, 1 = lundi, ..., 6 = samedi
			const daysToAdd = (8 - currentDay) % 7;

			for (let dayIndex = 0; dayIndex < days.length; dayIndex++) {
				// Calculer la date du jour en cours
				const dayDate = new Date(currentDate);
				dayDate.setDate(currentDate.getDate() + daysToAdd + dayIndex);

				const dayNumber = dayDate.getDate();

				ctx.font = "64px Impact";
				// Vérifier si une heure de début est définie
				const startTime = form[`${days[dayIndex].name}StartTime`].value;
				if (!startTime) {
					ctx.fillStyle = "#808080";
					ctx.fillText(`${days[dayIndex].display} ${dayNumber}`, days[dayIndex].x, days[dayIndex].y);
					ctx.font = "48px Arial";
					ctx.fillText("Pas de live", days[dayIndex].x, days[dayIndex].y + 64);
					ctx.fillStyle = "#220000";
					continue; // Passer au jour suivant
				}
				ctx.fillText(`${days[dayIndex].display} ${dayNumber}`, days[dayIndex].x, days[dayIndex].y);
				ctx.font = "64px Arial";

				// Ajouter la deuxième ligne de texte
				const endTime = form[`${days[dayIndex].name}EndTime`].value;
				const startHours = startTime.split(":")[0];
				const startMinutes = startTime.split(":")[1];
				const endHours = endTime ? endTime.split(":")[0] : "";
				const endMinutes = endTime ? endTime.split(":")[1] : "";
				const meetingTime = `${startHours}h${startMinutes>0?startMinutes:""}` + (endHours ? ` - ${endHours}h${endMinutes>0?endMinutes:""}` : "");
				if(meetingTime.length > 8) {
					ctx.font = "48px Arial";
				}
				ctx.fillText(meetingTime, days[dayIndex].x, days[dayIndex].y + 64);

				// Ajouter la troisième ligne si un commentaire est défini
				var comment = form[`${days[dayIndex].name}Theme`].value;
				var comment2 = form[`${days[dayIndex].name}Theme2`].value;
				if(!comment && comment2) {
					comment = comment2
					comment2 = null
				}
				if (comment) {
					ctx.font = (comment.lenght>16?"40":"48") + "px Arial";
					ctx.fillText(comment, days[dayIndex].x, days[dayIndex].y + 128);
				}
				if (comment2) {
					ctx.font = (comment2.lenght>16?"40":"48") + "px Arial";
					ctx.fillText(comment2, days[dayIndex].x, days[dayIndex].y + 192);
				}
			}

			// Convertir le canvas en image en base64
			const generatedImageURL = canvas.toDataURL("image/png");

			// Afficher l'image générée dans la zone de prévisualisation
			const imageElement = document.createElement("img");
			imageElement.src = generatedImageURL;
			imagePreview.innerHTML = ""; // Effacer la prévisualisation précédente
			imagePreview.appendChild(imageElement);
		};
	}

	function sendMessage() {
		const confirmMessage = confirm("Êtes-vous sûr(e) que l'image vous convient ?");

		if (!confirmMessage) {
			return;
		}

		const messageContent = document.getElementById("message").value;

		// Créer un objet FormData pour envoyer le contenu du formulaire
		const formData = new FormData();
		formData.append("content", messageContent);

		// Récupérer l'image en tant que fichier depuis l'élément img
		const imageDataURL = document.querySelector("#imagePreview img").src;
		const imageBlob = dataURLtoBlob(imageDataURL);
		formData.append("file", imageBlob, "image.png");

		// Envoyer le formulaire au webhook Discord
		fetch(WEBHOOK_DISCORD, {
			method: "POST",
			body: formData
		})
			.then(response => {
				if (response.ok) {
					alert("Message envoyé avec succès !");
				} else {
					alert("Une erreur est survenue lors de l'envoi du message.");
				}
			})
			.catch(error => {
				console.error("Erreur lors de l'envoi du message :", error);
				alert("Une erreur est survenue lors de l'envoi du message.");
			});
	}

	// Convertir une URL de données en un objet Blob
	function dataURLtoBlob(dataURL) {
		const arr = dataURL.split(",");
		const mime = arr[0].match(/:(.*?);/)[1];
		const byteString = atob(arr[1]);
		let n = byteString.length;
		const u8arr = new Uint8Array(n);
		while (n--) {
			u8arr[n] = byteString.charCodeAt(n);
		}
		return new Blob([u8arr], { type: mime });
	}

	function loadImage(url) {
		return new Promise((resolve, reject) => {
			const img = new Image();
			img.onload = () => resolve(img);
			img.onerror = () => reject(new Error(`Failed to load image at ${url}`));
			img.src = url;
		});
	}

	function loadFont(fontFamily) {
		const font = new FontFaceObserver(fontFamily);
		return font.load();
	}

	function generateCard() {
		const name = document.getElementById('name').value;
		let userImg;
		try {
			userImg = URL.createObjectURL(document.getElementById('image').files[0]);
		} catch(e) {
			document.getElementById('image').setCustomValidity("Veuillez choisir une image");
			document.getElementById('image').reportValidity();
			return
		}
		const effect = document.getElementById('effet').value.match(/[^\n]+/g);
		const lore = document.getElementById('lore').value.match(/[^\n]+/g);
		const force = document.getElementById('force').value;
		const vie = document.getElementById('vie').value;

		if(!/^.{1,30}$/.test(name)) {
			document.getElementById('name').reportValidity();
			return;
		}
		console.log("a")
		if(!["0","1","2","3","4"].includes(force)) {
			document.getElementById('force').reportValidity();
			return
		}
		console.log(0)
		if(!["0","1","2","3","4"].includes(vie)) {
			document.getElementById('vie').reportValidity();
			return
		}
		console.log(1)

		const resources = [
			loadImage('public/create/fond.png'),
			loadImage('public/create/masque.png'),
			loadImage(`public/create/F${force}.png`),
			loadImage(`public/create/V${vie}.png`),
			loadImage(userImg)
		];
		console.log(2)

		Promise.all(resources).then(values => {
		console.log(3)
			const [background, masque1, masque2, masque3, illustration] = values;

			// Tous vos chargements sont terminés, continuez à utiliser les ressources ici
			const canvas = document.createElement('canvas');
			const ctx = canvas.getContext('2d');
			canvas.width = 1495;
			canvas.height = 2062;

			// Fond
			ctx.drawImage(background, 0, 0);

			// Nom de la carte
			const name = document.getElementById('name').value
			ctx.fillStyle = '#fff5ed';
			ctx.fillRect(80, 90, 40 * name.length, 70);

			ctx.font = '96px "Caveat Brush"';
			ctx.textAlign = 'left';
			ctx.fillStyle = '#dfc5b7';
			ctx.fillText(name, 86, 166); // Ombre
			ctx.fillStyle = '#000000';
			ctx.fillText(name, 80, 160); // Text

			// Image de l'utilisateur
			ctx.drawImage(illustration, 12, 259, 1471, 1228); // Ajuster les coordonnées et dimensions

			// Effet
			ctx.font = 'bold 72px Playball';
			ctx.textAlign = 'center';
			console.log(effect)
			for(let i = 0; i < effect.length && i < 3; i++) {
				ctx.fillStyle = '#ffbe7c';
				ctx.fillText(effect[i], 752, (effect.length < 3 ? 1604 : 1572) + 80*i, i == 0 ? 1400 : 800, 100); // Ombre
				ctx.fillStyle = '#000000';
				ctx.fillText(effect[i], 748, (effect.length < 3 ? 1600 : 1568) + 80*i, i == 0 ? 1400 : 800, 100); // Texte
			}
			// Lore
			ctx.font = '64px Playball';
			ctx.textAlign = 'center';
			for(let i = 0; i < lore.length && i < 2; i++) {
				ctx.fillStyle = '#ffbe7c';
				ctx.fillText(lore[i], 762, 1824 + 72*i, 700, 100); // Ombre
				ctx.fillStyle = '#000000';
				ctx.fillText(lore[i], 758, 1820 + 72*i, 700, 100); // Texte
			}

			ctx.drawImage(masque1, 0, 0);
			ctx.drawImage(masque2, 0, 1662);
			ctx.drawImage(masque3, 1095, 1662);

			const cardImageURL = canvas.toDataURL('image/png');
			document.getElementById('cardPreview').innerHTML = `<img src="${cardImageURL}" />`;  // Afficher l'image générée
		}).catch(error => {
			console.error('Failed to load one or more resources:', error);
		});
	}
});

	</script>
</body>
</html>
